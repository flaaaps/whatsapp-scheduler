# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

WhatsApp message scheduler built with:
- **Backend**: @whiskeysockets/baileys v7, Express 5, PostgreSQL, node-cron
- **Frontend**: Remix 2 with Vite 6, React 19, Server-Side Rendering
- **Infrastructure**: Docker, TypeScript, ES Modules, tsx (TypeScript execution)
- **Node Version**: 20+ (required by Baileys and other dependencies)

The application provides a modern web UI for scheduling WhatsApp messages (one-time or recurring CRON jobs) and managing contacts.

## Running the Application

**IMPORTANT**: Node.js 20 or higher is required.

### Local Development

```bash
# Start the development server with hot reload
npm run dev
```

The application will:
- Start on port 3000
- Run TypeScript directly using `tsx` (no compilation needed)
- Initialize WhatsApp connection (QR code on first run)
- Serve Remix UI with Vite hot module replacement
- Connect to PostgreSQL database (if configured)
- Persist WhatsApp auth in the `auth/` directory

### Production Mode

```bash
# Build both Remix frontend and backend
npm run build

# Start the production server (runs the compiled dist/server.js)
npm start
```

### Docker (Recommended for Production)

```bash
# Build and start with docker-compose
docker-compose up -d

# View logs (to see QR code for first-time setup)
docker-compose logs -f

# Rebuild after code changes
docker-compose up -d --build

# Stop the container
docker-compose down
```

### Environment Variables

Create a `.env` file in the project root:
```
ADMIN_USER=admin
ADMIN_PASS=your-secure-password
PORT=3000

# PostgreSQL (used when running locally, auto-configured in Docker)
POSTGRES_USER=whatsapp
POSTGRES_PASSWORD=your-db-password
POSTGRES_DB=whatsapp_scheduler
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
```

## Project Structure

```
whatsapp-scheduler/
├── server.ts                 # Main entry point (Express + Remix + Services)
├── app/                      # Remix application (TypeScript + React)
│   ├── .server/              # Backend services (Remix .server convention)
│   │   ├── api.server.ts     # REST API route handlers
│   │   ├── whatsapp.server.ts    # WhatsApp connection & messaging
│   │   ├── scheduler.server.ts   # Job scheduling logic
│   │   ├── db.server.ts          # PostgreSQL operations
│   │   ├── constants.server.ts   # Configuration constants
│   │   └── context.server.ts     # Shared types for services
│   ├── routes/
│   │   ├── _index.tsx        # Main scheduler page (/)
│   │   └── contacts.tsx      # Contacts management page (/contacts)
│   ├── styles/
│   │   └── global.css        # Global styles
│   ├── root.tsx              # Root Remix layout
│   ├── entry.client.tsx      # Client-side hydration entry
│   ├── entry.server.tsx      # Server-side rendering entry
│   └── types.ts              # Shared TypeScript types
├── dist/                     # Compiled backend (generated by tsup)
├── build/                    # Compiled Remix app (generated by Vite)
├── auth/                     # WhatsApp auth state (generated/mounted)
├── database/                 # PostgreSQL initialization scripts
├── vite.config.ts            # Vite + Remix configuration
├── tsconfig.json             # TypeScript configuration
├── tsup.config.ts            # tsup bundler configuration
├── Dockerfile                # Multi-stage Docker build
└── docker-compose.yml        # Docker orchestration
```

## Development

### Build System
- **Backend**: TypeScript files bundled with `tsup` (powered by esbuild)
  - Uses Remix `.server.ts` convention for server-only modules
  - **No `.js` extensions needed in imports** (tsup handles module resolution)
- **Frontend**: Remix + Vite → Server + Client bundles (`app/` → `build/`)
- **Dev Mode**:
  - Uses `tsx` to run `server.ts` directly with hot-reload
  - Vite middleware integrated into Express for frontend HMR
- **Prod Mode**: Both Remix and backend are pre-built and optimized

### Architecture: Hybrid Remix + Express

The application uses a **hybrid architecture**:
1. **Remix handles all UI routes** (`/`, `/contacts`, etc.)
2. **Express handles all API routes** (`/api/*`)
3. **Vite is integrated into Express** via middleware in development
4. **Authentication** (Basic Auth) is applied globally to both Remix and API routes
5. **Services** are in `app/.server/` and shared between Remix and Express

**Key Integration Points:**
- `server.ts` - Creates Express app with Remix request handler
- `app/.server/api.server.ts` - API routes mounted to Express
- `app/.server/*.server.ts` - Backend services (WhatsApp, DB, Scheduler)
- Services injected into Remix via `getLoadContext()` in server.ts
- **Remix loaders/actions use services directly** (no API calls needed)

### Scripts
- `npm run dev` - Development mode with hot-reload (runs `tsx server.ts`)
- `npm run build` - Build both Remix and backend (`build:remix` + `build:server`)
- `npm run build:remix` - Build Remix app only with Vite
- `npm run build:server` - Build backend only with tsup
- `npm start` - Run production build (executes `dist/server.js`)
- `npm run clean` - Remove build/ and dist/ folders
- `npm run typecheck` - Type-check without building
- `npm run docker:build` - Build Docker image
- `npm run docker:run` - Run with Docker Compose
- `npm run docker:build:run` - Build and run with Docker Compose

## Authentication

The app uses HTTP Basic Auth:
- Credentials are stored in `.env` file
- Default: `ADMIN_USER` and `ADMIN_PASS`
- All web UI and API endpoints require authentication
- Configuration in `app/.server/constants.server.ts`
- Passed to Remix via `getLoadContext()` in server.ts

## Architecture

### Backend Services

#### 1. Entry Point (`server.ts`)
- Initializes database connection
- Initializes WhatsApp connection
- Creates and starts Express server (with Remix integration)
- Vite dev server integration (development mode)
- Basic Auth middleware
- API routes mounting
- Remix request handler with service injection
- Graceful shutdown handlers

#### 2. Database Service (`app/.server/db.server.ts`)
**Exports:**
- `initializeDatabase()` - Initialize PostgreSQL connection pool
- `getAllContacts()` - Get all contacts from database
- `getContactById(id)` - Get single contact
- `getContactByPhone(phone)` - Find contact by phone number
- `createContact(data)` - Create new contact
- `updateContact(id, data)` - Update existing contact
- `deleteContact(id)` - Delete contact
- `closeDatabase()` - Close connection pool

**Features:**
- PostgreSQL connection pooling
- Full CRUD operations for contacts
- Dynamic query building for updates
- Error handling for constraint violations

#### 3. WhatsApp Service (`app/.server/whatsapp.server.ts`)
**Exports:**
- `initializeWhatsApp()` - Initialize Baileys connection
- `getWhatsAppSocket()` - Get current socket instance
- `sendMessage(to, text)` - Send a message
- `getConnectionStatus()` - Get connection state
- `getCurrentUser()` - Get logged-in user info

**Features:**
- Multi-file auth state (persisted in `auth/` directory)
- Auto-reconnection on disconnect (unless logged out)
- QR code generation for pairing
- Connection state management

#### 4. Scheduler Service (`app/.server/scheduler.server.ts`)
**Exports:**
- `scheduleCron(to, text, cron)` - Schedule recurring message
- `scheduleOnce(to, text, timestamp)` - Schedule one-time message
- `cancelScheduledJob(id)` - Cancel a scheduled job
- `getAllScheduledJobs()` - Get all active jobs

**Features:**
- In-memory Map for job storage
- Unique timestamp-based job IDs
- Support for both cron and one-time schedules

#### 5. API Routes (`app/.server/api.server.ts`)
**Messaging Endpoints:**
- `POST /api/schedule` - Schedule new message (cron or timestamp)
- `DELETE /api/schedule/:id` - Cancel scheduled job
- `GET /api/status` - Connection status + scheduled jobs

**Contact Management Endpoints:**
- `GET /api/contacts` - Get all contacts from database
- `GET /api/contacts/:id` - Get single contact
- `POST /api/contacts` - Create new contact
- `PUT /api/contacts/:id` - Update contact
- `DELETE /api/contacts/:id` - Delete contact

**Features:**
- Fully typed request/response handlers
- Error handling and validation
- Duplicate phone number detection
- Phone format validation

### Frontend (Remix)

#### Routes

**Main Scheduler** (`app/routes/_index.tsx`):
- Loader: Uses services from context to get status and contacts
- Action: Handles schedule creation and job cancellation via services
- UI Features:
  - Contact dropdown selector
  - Message textarea
  - Mode selector (once/cron)
  - Dynamic fields based on mode
  - Scheduled jobs table
  - Real-time status badge

**Contacts Management** (`app/routes/contacts.tsx`):
- Loader: Uses services from context to get all contacts
- Action: Handles create/update/delete operations via services
- UI Features:
  - Add contact form
  - Contacts table
  - Edit modal with overlay
  - Delete confirmation
  - Success/error messages
  - Optimistic UI updates via useFetcher

#### Data Flow
1. User interacts with Remix UI
2. Form submission → Remix action
3. **Action uses services directly from context** (no API fetch needed)
4. Services interact with database/WhatsApp/scheduler
5. Response returned to action
6. Loader revalidates data
7. UI updates

**Note**: Remix routes can access backend services directly via the `context.services` object passed through `getLoadContext()`. This eliminates the need for internal API calls.

### WhatsApp Message Format

All messages use Baileys JID format:
- Phone numbers are formatted as `${phoneNumber}@s.whatsapp.net`
- Example: `491701234567@s.whatsapp.net`

### Contacts System

Contacts are stored in PostgreSQL and accessed via:
- **Database**: `app/.server/db.server.ts` - CRUD operations
- **API**: `app/.server/api.server.ts` - RESTful endpoints (optional)
- **UI**: `app/routes/contacts.tsx` - Remix route with direct service access

#### Database Schema
```sql
CREATE TABLE contacts (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    phone VARCHAR(50) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## State Management

**Scheduled Jobs**: In-memory only. Restarting the application will clear all scheduled messages.

**Contacts**: Persisted in PostgreSQL database. Survives application restarts.

**WhatsApp Auth**: Persisted to disk in `auth/` directory. Delete this folder to re-pair with WhatsApp.

## Dependencies

**Runtime:**
- `@whiskeysockets/baileys` - WhatsApp Web API client
- `express` - Web server
- `express-basic-auth` - HTTP Basic Auth middleware
- `node-cron` - CRON job scheduler
- `qrcode-terminal` - QR code display for WhatsApp pairing
- `pg` - PostgreSQL client
- `@remix-run/node`, `@remix-run/express`, `@remix-run/react` - Remix framework
- `react`, `react-dom` - React 19
- `isbot` - Bot detection for SSR
- `cross-env` - Cross-platform environment variables

**Development:**
- `typescript` - TypeScript compiler
- `tsx` - TypeScript execution with hot-reload (for dev mode)
- `tsup` - TypeScript bundler powered by esbuild (for production)
- `vite` - Build tool and dev server
- `@remix-run/dev` - Remix Vite plugin
- `vite-tsconfig-paths` - Path resolution for Vite
- `@types/*` - Type definitions

## Adding New Features

### Adding a new Remix route:
1. Create route file in `app/routes/`
2. Export `loader` function for data fetching (access services via `context.services`)
3. Export `action` function for mutations (access services via `context.services`)
4. Export default React component
5. Add navigation link in other routes

### Adding a new API endpoint:
1. Add route handler in `app/.server/api.server.ts`
2. Add request/response types in `app/types.ts` if needed
3. Import and use services from `app/.server/`

### Adding new scheduler functionality:
1. Add function in `app/.server/scheduler.server.ts`
2. Export the function
3. Use in Remix actions or API handlers

## Docker Deployment

The project includes Docker support for production deployment.

### Docker Files
- **Dockerfile** - Multi-stage build using Node.js 20 Alpine
- **docker-compose.yml** - Orchestration with PostgreSQL
- **.dockerignore** - Excludes build artifacts and node_modules

### Build Process
1. **Stage 1 (Builder)**: Install all deps → Build Remix + Backend with tsup
2. **Stage 2 (Production)**: Install prod deps → Copy build artifacts → Run compiled server

### Key Features
- **Persistent Auth**: `auth/` directory mounted as volume
- **Database**: PostgreSQL service with persistent volume
- **Environment Variables**: Configurable via docker-compose
- **Auto-restart**: Both containers restart unless manually stopped
- **Healthchecks**: Database healthcheck for reliable startup
- **Internal Networking**: App connects to DB without port exposure

### Volume Mounts
- `./auth:/app/auth` - WhatsApp authentication persistence
- `postgres_data:/var/lib/postgresql/data` - Database persistence

## Common Issues

**Node Version Error**: Ensure you're using Node.js 20 or higher. Check with `node -v`.

**QR Code Not Scanning**: The QR code appears in the terminal. Scan it with WhatsApp's "Linked Devices" feature.

**Connection Lost**: Application auto-reconnects unless explicitly logged out. If logged out, delete `auth/` folder and restart.

**Scheduled Jobs Lost**: Jobs are in-memory only. Server restart clears all schedules.

**TypeScript Errors**: Run `npm run typecheck` to check for type errors before deployment.

**Import Errors**: Imports should NOT use `.js` extensions. tsup handles module resolution automatically.

**Vite Compatibility**: The project uses Vite 6 for compatibility with Remix 2.17. Vite 7 is not yet supported.

**Database Connection**: When running locally (not Docker), ensure PostgreSQL is running and environment variables are set in `.env`.

## Module System

Uses ES modules with TypeScript:
- `type: "module"` in package.json
- **No `.js` extensions needed** in imports (tsup handles module resolution)
- Module resolution: "bundler" (TypeScript config)
- **Dev mode**: Backend runs with `tsx` which transpiles TypeScript on-the-fly
- **Production**: Backend bundled with `tsup` (esbuild) into optimized single file
- Remix frontend is bundled by Vite for optimization
