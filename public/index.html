<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>WhatsApp Scheduler</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<style>
		* {
			box-sizing: border-box;
		}

		body {
			font-family: system-ui, sans-serif;
			max-width: 700px;
			margin: 2rem auto;
			padding: 1rem;
			background: #f9fafb;
			color: #111;
		}

		h1 {
			font-size: 1.5rem;
		}

		form,
		.status,
		.scheduled {
			background: white;
			padding: 1rem;
			border-radius: 8px;
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
			margin-bottom: 1.5rem;
		}

		label {
			display: block;
			margin-top: 0.5rem;
			font-weight: 500;
		}

		input,
		textarea,
		select {
			width: 100%;
			padding: 0.5rem;
			border: 1px solid #ccc;
			border-radius: 6px;
			margin-top: 0.25rem;
			font-size: 1rem;
		}

		textarea {
			resize: vertical;
		}

		button {
			background: #16a34a;
			color: white;
			border: none;
			border-radius: 6px;
			padding: 0.6rem 1.2rem;
			font-size: 1rem;
			margin-top: 1rem;
			cursor: pointer;
		}

		button:hover {
			background: #15803d;
		}

		.btn-cancel {
			background: #dc2626;
			color: white;
			border: none;
			border-radius: 6px;
			padding: 0.3rem 0.6rem;
			cursor: pointer;
		}

		.btn-cancel:hover {
			background: #b91c1c;
		}

		.small {
			font-size: 0.85rem;
			color: #555;
		}

		.badge {
			display: inline-block;
			padding: 0.3rem 0.7rem;
			border-radius: 999px;
			font-size: 0.8rem;
			font-weight: 600;
		}

		.connected {
			background: #dcfce7;
			color: #166534;
		}

		.disconnected {
			background: #fee2e2;
			color: #991b1b;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 0.5rem;
		}

		th,
		td {
			padding: 0.5rem;
			border-bottom: 1px solid #e5e7eb;
			text-align: left;
			font-size: 0.9rem;
		}

		th {
			background: #f3f4f6;
		}
	</style>
</head>

<body>
	<h1>üìÖ WhatsApp Message Scheduler</h1>

	<div class="status">
		<strong>Status:</strong> <span id="statusBadge" class="badge disconnected">checking...</span>
		<div id="me" class="small"></div>
	</div>

	<form id="scheduleForm">
		<div style="margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between;">
			<label style="flex: 1;" for="pick-number">Pick number from address book</label>
			<input style="flex: 0;" type="checkbox" onchange="pickFromAddressBookChanged(event)" checked name=""
				id="pick-number">
		</div>

		<select id="address-book-select">
		</select>

		<div id="recipient-input" style="display: none;">
			<label>Recipient (phone number, e.g. 491701234567)</label>
			<input id="to" />
		</div>

		<label>Message</label>
		<textarea id="text" rows="3" required></textarea>

		<label>Send Type</label>
		<select id="mode">
			<option value="once">Send once at specific time</option>
			<option value="cron">Repeat using CRON pattern</option>
		</select>

		<div id="onceFields">
			<label>Date &amp; Time (local)</label>
			<input type="datetime-local" id="datetime" />
		</div>

		<div id="cronFields" style="display:none">
			<label>CRON Expression</label>
			<input id="cron" placeholder="* * * * *" />
			<div class="small">Example: "0 9 * * *" = every day at 09:00</div>
		</div>

		<button type="submit">üí¨ Schedule Message</button>
	</form>

	<div class="scheduled">
		<h3>Scheduled Jobs</h3>
		<table id="jobsTable">
			<thead>
				<tr>
					<th>ID</th>
					<th>To</th>
					<th>Text</th>
					<th>Type</th>
					<th>When</th>
					<th></th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
	</div>

	<script>
		const api = location.origin + "/api";

		async function fetchAndRenderContacts() {
			try {
				const res = await fetch(api + "/contacts");
				const contacts = await res.json();

				const addressBookSelect = document.getElementById("address-book-select");

				for (const contact of contacts) {
					const option = document.createElement("option");
					option.setAttribute("data-phone", contact.phone)
					option.innerText = `${contact.name} | ${contact.phoneDisplay}`
					addressBookSelect.appendChild(option)
				}
			} catch (err) {
				console.error(err);
			}
		}

		async function fetchStatus() {
			try {
				const res = await fetch(api + "/status");
				const data = await res.json();
				const badge = document.getElementById("statusBadge");
				badge.textContent = data.status;
				badge.className = "badge " + data.status;
				document.getElementById("me").textContent = data.me?.id ? "Logged in as " + data.me.id : "";
				renderJobs(data.scheduled || []);
			} catch (err) {
				console.error(err);
			}
		}

		function renderJobs(jobs) {
			const tbody = document.querySelector("#jobsTable tbody");
			tbody.innerHTML = "";
			for (const j of jobs) {
				const tr = document.createElement("tr");
				const when = j.when ? new Date(j.when).toLocaleString() : (j.cron || "-");
				tr.innerHTML = `
          <td>${j.id}</td>
          <td>${j.to}</td>
          <td>${j.text}</td>
          <td>${j.type}</td>
          <td>${when}</td>
          <td><button class="btn-cancel" data-id="${j.id}">Cancel</button></td>
        `;
				tbody.appendChild(tr);
			}

			document.querySelectorAll(".btn-cancel").forEach(btn => {
				btn.addEventListener("click", async () => {
					const id = btn.dataset.id;
					if (!confirm("Cancel job " + id + "?")) return;
					await fetch(api + "/schedule/" + id, { method: "DELETE" });
					fetchStatus();
				});
			});
		}

		function pickFromAddressBookChanged(e) {
			console.log("Pick changed", e)

			const addressBookSelect = document.getElementById("address-book-select");
			const recipientInput = document.getElementById("recipient-input");
			if (e.target.checked) {
				addressBookSelect.style.display = 'block';
				recipientInput.style.display = 'none'
			} else {
				addressBookSelect.style.display = 'none';
				recipientInput.style.display = 'block'

			}
		}

		document.getElementById("mode").addEventListener("change", e => {
			const isCron = e.target.value === "cron";
			document.getElementById("cronFields").style.display = isCron ? "block" : "none";
			document.getElementById("onceFields").style.display = isCron ? "none" : "block";
		});

		document.getElementById("scheduleForm").addEventListener("submit", async e => {
			e.preventDefault();

			const pickFromAddressBook = document.getElementById("pick-number").checked

			const selectedOption = document.getElementById("address-book-select").selectedOptions?.[0]

			const to = pickFromAddressBook ? selectedOption.getAttribute("data-phone") : document.getElementById("to").value.trim();
			const text = document.getElementById("text").value.trim();
			const mode = document.getElementById("mode").value;

			let body = { to, text };

			if (mode === "once") {
				const dt = document.getElementById("datetime").value;
				if (!dt) return alert("Please choose a date and time.");
				body.timestamp = new Date(dt).getTime();
			} else {
				const cron = document.getElementById("cron").value.trim();
				if (!cron) return alert("Please enter a CRON pattern.");
				body.cron = cron;
			}

			const res = await fetch(api + "/schedule", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(body)
			});

			const data = await res.json();
			if (res.ok) {
				alert("‚úÖ Scheduled successfully!");
				fetchStatus();
			} else {
				alert("‚ùå Error: " + data.error);
			}
		});

		fetchStatus();
		fetchAndRenderContacts();
		setInterval(fetchStatus, 5000);
	</script>
</body>

</html>